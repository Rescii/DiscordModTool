{"version":3,"sources":["../src/index.ts"],"names":["COMMAND","spinner","sigar","Sigar","defaultOptions","commandTemplate","cwd","process","terminals","darwin","linux","getDefaultTerminalCommand","REGEX","fs","realpath","terminalPath","command","match","message","indexOf","undefined","createSafeCommand","uid","platform","path","resolve","__dirname","Buffer","from","toString","hasTerminal","terminal","Array","isArray","openTerminal","options","openDefaultTerminal","_terminals","_i","fullOptions","mergeDefaults","Error","defaultTerminalCommand","sort","a","safeCommand","join","warn","map","shell","stdio","result","tryOpenTerminal","exit","error","failed","cmd","arg","replace","args","p","Promise","r","setTimeout","waitOnTerminal","on","pid","uidToPid","kill","procList","find","getProcArgs","pollInterval","timeout","Object","entries","reduce","osTerminals","os","existingTerminal","push"],"mappings":"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","sourcesContent":["import Sigar from 'node-sigar';\nimport execa, { ExecaError } from 'execa';\nimport fs from 'fs-extra';\nimport ora from 'ora';\nimport path from 'path';\nimport which from 'which';\nimport { v4 as uuidv4 } from 'uuid';\nimport { Options, Terminals, Terminal } from '~/types';\n\nconst COMMAND = '([{<COMMAND>}])';\nconst spinner = ora();\nconst sigar = new Sigar();\n\nexport const defaultOptions: Options = {\n  commandTemplate: COMMAND,\n  cwd: process.cwd(),\n  terminals: {\n    darwin: [\n      ['osascript', '-e', `tell app \"Terminal\" to do script \"${COMMAND}\"`]\n    ],\n    linux: [\n      ['gnome-terminal', '--', 'sh', '-c', COMMAND],\n      ['xterm', '-e', `sh -c \"${COMMAND}\"`],\n      ['konsole', '-e', `sh -c \"${COMMAND}\"`],\n      ['terminator', '-u', '-e', `sh -c \"${COMMAND}\"`]\n    ]\n  }\n};\n\nasync function getDefaultTerminalCommand(): Promise<string | undefined> {\n  try {\n    const REGEX = /[^/]+$/g;\n    const terminalPath = await fs.realpath(await which('x-terminal-emulator'));\n    const command = [...(terminalPath.match(REGEX) || [])]?.[0];\n    return command;\n  } catch (err) {\n    if (err.message.indexOf('not found') > -1) return undefined;\n    throw err;\n  }\n}\n\nfunction createSafeCommand(uid: string, command: string) {\n  if (process.platform === 'darwin') {\n    command = `cd ${process.cwd()} && ${command}`;\n  }\n  return `node ${path.resolve(__dirname, '../lib/shb64')} ${Buffer.from(\n    command\n  ).toString('base64')} open-terminal:uid:${uid}`;\n}\n\nasync function hasTerminal(terminal: Terminal | string) {\n  const command = Array.isArray(terminal) ? terminal?.[0] || '' : terminal;\n  try {\n    await which(command);\n    return true;\n  } catch (err) {\n    if (err.message.indexOf('not found') > -1) return false;\n    throw err;\n  }\n}\n\nexport default async function openTerminal(\n  command: string | string[],\n  options?: Partial<Options>\n) {\n  return openDefaultTerminal(command, options);\n}\n\nasync function openDefaultTerminal(\n  command: string | string[],\n  options?: Partial<Options>,\n  _terminals?: Terminal[],\n  _i = 0\n) {\n  const uid = uuidv4();\n  const fullOptions = mergeDefaults(options);\n  if (!_terminals) {\n    const terminals = fullOptions.terminals[process.platform];\n    if (!terminals) {\n      throw new Error(`operating system ${process.platform} not supported`);\n    }\n    const defaultTerminalCommand = await getDefaultTerminalCommand();\n    _terminals = terminals.sort((a: Terminal) => {\n      if ((a[0] || '').indexOf(defaultTerminalCommand || '') > -1) return -1;\n      return 1;\n    });\n  }\n  const safeCommand = createSafeCommand(\n    uid,\n    (Array.isArray(command) ? command : [command]).join(' ')\n  );\n  const terminal = _terminals[_i];\n  if (!terminal) {\n    spinner.warn(\n      `running process in background because terminal could not be found\ntry installing on of the following terminals to run correctly: ${_terminals\n        .map((terminal: Terminal) => terminal[0])\n        .join(', ')}\n`\n    );\n    const result = await execa(safeCommand, {\n      cwd: fullOptions.cwd,\n      shell: true,\n      stdio: 'inherit'\n    });\n    return result;\n  }\n  if (!(await hasTerminal(terminal))) {\n    return openDefaultTerminal(command, options, _terminals, ++_i);\n  }\n  try {\n    await tryOpenTerminal(uid, terminal, safeCommand, fullOptions);\n    return process.exit();\n  } catch (err) {\n    const error: ExecaError = err;\n    if (error.command && error.failed) {\n      return openDefaultTerminal(command, options, _terminals, ++_i);\n    }\n    throw err;\n  }\n}\n\nasync function tryOpenTerminal(\n  uid: string,\n  terminal: Terminal,\n  command: string | string[],\n  options?: Options\n) {\n  const { commandTemplate, cwd } = mergeDefaults(options);\n  const [cmd] = terminal;\n  if (!cmd) {\n    throw new Error(`terminal ${terminal[0]} not found`);\n  }\n  const [, ...args] = terminal.map((arg: string) =>\n    arg.replace(\n      commandTemplate,\n      Array.isArray(command) ? command.join(' ') : command\n    )\n  );\n  const p = execa(cmd, args, {\n    stdio: 'inherit',\n    cwd\n  });\n  await new Promise((r) => setTimeout(r, 1000));\n  await waitOnTerminal(uid);\n  const result = await p;\n  process.on('SIGINT', () => {\n    const pid = uidToPid(uid);\n    if (pid) process.kill(pid);\n    process.exit();\n  });\n  process.on('SIGTERM', () => {\n    const pid = uidToPid(uid);\n    if (pid) process.kill(pid);\n    process.exit();\n  });\n  return result;\n}\n\nfunction uidToPid(uid: string) {\n  return sigar.procList.find((pid: number) => {\n    return sigar.getProcArgs(pid).join(' ').indexOf(uid) > -1;\n  });\n}\n\nasync function waitOnTerminal(\n  uid: string,\n  pollInterval = 3000,\n  timeout?: number\n) {\n  await new Promise((r) => setTimeout(r, pollInterval));\n  const pid = uidToPid(uid);\n  if (!pid) return undefined;\n  return waitOnTerminal(\n    uid,\n    timeout,\n    typeof timeout === 'undefined' ? timeout : timeout - pollInterval\n  );\n}\n\nfunction mergeDefaults(options?: Partial<Options>): Options {\n  return {\n    ...defaultOptions,\n    ...(options || {}),\n    terminals: {\n      ...defaultOptions.terminals,\n      ...Object.entries(options?.terminals || {}).reduce(\n        (osTerminals: Terminals, [os, terminals]: [string, Terminal[]]) => {\n          osTerminals[os] = (terminals || []).reduce(\n            (terminals: Terminal[], terminal: Terminal) => {\n              if (\n                !terminals.find((existingTerminal: Terminal) => {\n                  return existingTerminal[0] === terminal[0];\n                })\n              ) {\n                terminals.push(terminal);\n              }\n              return terminals;\n            },\n            []\n          );\n          return osTerminals;\n        },\n        {}\n      )\n    }\n  };\n}\n\nexport * from '~/types';\n"],"file":"index.js"}